<!DOCTYPE HTML>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
  <link rel="stylesheet" type="text/css" href="style.css">
</head>
<body>
  <table style="width: 100%;">
    <tr>
      <td style="text-align: center; width: 20%;"><img src="logo.png"></img></td>
      <td style="text-align: center;">
        <h1 id="title"></h1>
        <p id="copyright"></p>
      </td>
      <td style="width: 20%;"></td>
    </tr>
  </table>

  <table style="width: 100%;">
    <tr>
      <td class="left" >Version:</td>
      <td id="version" class="left" style="width: 50%;"></td>
      <td class="right" style="width: 50%;"><a href="/settings">Settings</a>&nbsp;</td>
      <td class="right" style="width: 50%;"><a href="#" onclick="refreshPage()">Refresh</a></td>
    </tr>
    <tr>
      <td class="left" style="padding-right: 12px;white-space: nowrap;">Memory Used</td>
      <td id="memoryFree" class="left" style="width: 50%;"></td>
    </tr>
    <tr id="battery">
      <td class="left" style="padding-right: 12px;">Battery</td>
      <td class="left" colspan="2">
        <img id="battery-full" class="battery battery-full battery-sm" src="/transparent.png" style="display: none;" />
        <img id="battery-full-charging" class="battery battery-full-charging battery-sm" src="/transparent.png" style="display: none;" />
        <img id="battery-charging" class="battery battery-charging battery-sm" src="/transparent.png" style="display: none;" />
        <img id="battery-empty" class="battery battery-empty battery-sm" src="/transparent.png" style="display: none;" />
        <img id="battery-partial" class="battery battery-partial battery-sm" src="/transparent.png" style="display: none;" />
        <img id="battery-mostly" class="battery battery-mostly battery-sm" src="/transparent.png" style="display: none;" />
        <span class="middle" style="padding-right: 8px;display:inline-block"><span id="battery-voltage"></span>v</span>
      </td>
    </tr>
    <tr>
      <td class="left" style="padding-right: 12px;white-space: nowrap;">Pressure<br><span style="font-size: 75%">at sea level</span></td>
      <td id="pressureAt" class="left" style="width: 50%;"></td>
      <td class="left" style="padding-right: 12px;white-space: nowrap;">Samples/sec</td>
    </tr>
    <tr>
      <td class="left" style="padding-right: 12px;white-space: nowrap;">Pressure</td>
      <td id="pressureAbove" class="left" style="width: 50%;"></td>
      <td class="left" style="padding-right: 12px;white-space: nowrap;">&nbsp;&nbsp;Ascent</td>
      <td id="samplesAscent" class="left" style="width: 50%;"></td>
    </tr>
    <tr>
      <td class="left" style="padding-right: 12px;white-space: nowrap;">Temperature</td>
      <td id="temperature" class="left" style="width: 50%;"></td>
      <td class="left" style="padding-right: 12px;white-space: nowrap;">&nbsp;&nbsp;Descent</td>
      <td id="samplesDescent" class="left" style="width: 50%;"></td>
    </tr>
    <tr>
      <td class="left" style="padding-right: 12px;white-space: nowrap;">Altitude<br><span style="font-size: 75%">above sea level</span></td>
      <td id="altitudeASL" class="left" style="width: 50%;"></td>
      <td class="left" style="padding-right: 12px;white-space: nowrap;">&nbsp;&nbsp;Ground</td>
      <td id="samplesGround" class="left" style="width: 50%;"></td>
    </tr>
    <tr>
      <td class="left" style="padding-right: 12px;white-space: nowrap;">Launch Detect</td>
      <td id="launchDetect" class="left" style="width: 50%;"></td>
      <td class="left" style="padding-right: 12px;white-space: nowrap;">WIFI SSID</td>
      <td id="wifiSSID" class="left" style="width: 50%;"></td>
    </tr>
  </table>
  <p>
    <button class='home_buttons'><a href='/datalog'>Data Log Download</a></button>
    <button class='home_buttons' onclick="upload_handler()">Upload Firmware</button>
  </p>
  <p id="status"></p>
  <p id="upload_header"></p>
  <p id="upload"></p>
<script src="/script.js"></script>
<script>
function refreshPage() { 
  location.reload(); 
}

function directory_handler() {
  xml = new XMLHttpRequest();
  xml.open("GET", "/directory", false);
  xml.send();
  document.getElementById("status").innerHTML = "";
  document.getElementById("directory_details").innerHTML = xml.responseText;
}

function directory_button_handler(filename, action) {
  var urltocall = "/file?name=" + filename + "&action=" + action;
  xml = new XMLHttpRequest();
  if (action == "delete") {
    xml.open("GET", urltocall, false);
    xml.send();
    document.getElementById("status").innerHTML = "Deleted";
    document.getElementById("directory_details").innerHTML = "";
  }
  if (action == "download") {
    document.getElementById("status").innerHTML = "";
    window.open(urltocall,"_blank");
  }
}

function upload_handler() {
  document.getElementById("upload_header").innerHTML = "<h2>Upload File<h2>"
  document.getElementById("status").innerHTML = "";
  var uploadform =
  "<form id=\"upload_form\" enctype=\"multipart/form-data\" method=\"post\">" +
  "<input type=\"file\" name=\"file1\" id=\"file1\" onchange=\"uploadFile()\"><br>" +
  "<progress id=\"progressBar\" value=\"0\" max=\"100\" style=\"width:300px;\"></progress>" +
  "<h3 id=\"status\"></h3>" +
  "<p id=\"loaded_n_total\"></p>" +
  "</form>";
  document.getElementById("upload").innerHTML = uploadform;
}

function _(el) {
  return document.getElementById(el);
}

function uploadFile() {
  var file = _("file1").files[0];
  // alert(file.name+" | "+file.size+" | "+file.type);
  var formdata = new FormData();
  formdata.append("file1", file);
  var ajax = new XMLHttpRequest();
  ajax.upload.addEventListener("progress", upload_progress_handler, false);
  ajax.addEventListener("load", upload_complete_handler, false);
  ajax.addEventListener("error", upload_error_handler, false);
  ajax.addEventListener("abort", upload_abort_handler, false);
  ajax.open("POST", "/");
  ajax.send(formdata);
}

function upload_progress_handler(event) {
  _("loaded_n_total").innerHTML = "Uploaded " + event.loaded + " bytes";
  var percent = (event.loaded / event.total) * 100;
  _("progressBar").value = Math.round(percent);
  _("status").innerHTML = Math.round(percent) + "% uploaded... please wait";
  if (percent >= 100) {
    document.getElementById("directory_details").innerHTML = "";
    document.getElementById("upload_header").innerHTML = "";
    document.getElementById("upload").innerHTML = "";
  }
}

function upload_complete_handler(event) {
  _("status").innerHTML = "Upload Complete";
  _("progressBar").value = 0;
}

function upload_error_handler(event) {
  _("status").innerHTML = "Upload Failed";
}

function upload_abort_handler(event) {
  _("status").innerHTML = "Aborted";
}

function set(json) {
  header(json);
  atmosphere(json);
  battery_level(json);
  launch(json);
  memory(json);
  samples(json);
  wifi(json);
}

function init() {
  requestGet('/data', set);
}

init();
</script>
</body>
</html>